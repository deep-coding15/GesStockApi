name: GesStockApi C.D.

# DÃ©clencheurs du workflow
on:
  # Le workflow se lance automatiquement :
  workflow_run:
    workflows: ["GesStockApi C.I."]
    types: 
      - completed

jobs:
  deploy-docker-to-ec2:
    runs-on: self-hosted

    steps:
      - name: Pull Docker Image from Docker Hub
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/ges_stock_api:latest
          echo "Pulling latest image..."
          docker pull $IMAGE
      - name: Delete old container
        run: |
          echo "Stopping old container if exists..."
          sudo docker stop ges_stock_api || true
          sudo docker rm ges_stock_api || true
      - name: Run new Docker Container
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/ges_stock_api:latest
          echo "Running new container..."
          sudo docker run -d \
              -p 8080:8088 \
              --name ges_stock_api \
              --restart always \
              $IMAGE 
